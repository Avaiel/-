<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>好词好句收藏夹</title>
<style>
  :root{--gap:12px;--radius:12px}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;max-width:980px;margin:0 auto;padding:24px;background:#f7f7fb;color:#222}
  h1{font-size:22px;margin:0 0 16px}
  .card{background:#fff;border-radius:var(--radius);padding:16px;box-shadow:0 2px 10px rgba(0,0,0,.06);margin-bottom:var(--gap)}
  .row{display:flex;gap:var(--gap);flex-wrap:wrap}
  .row>*{flex:1 1 260px}
  input,textarea,select,button{width:100%;padding:10px 12px;border:1px solid #ddd;border-radius:10px;background:#fff;font-size:14px}
  textarea{min-height:80px;resize:vertical}
  button{cursor:pointer}
  button.primary{background:#222;color:#fff;border-color:#222}
  button.ghost{background:#fff}
  .quote{white-space:pre-wrap;line-height:1.6}
  .muted{color:#666;font-size:12px}
  .tag{display:inline-block;padding:2px 8px;border:1px solid #ddd;border-radius:999px;margin-right:6px;margin-top:6px;background:#fafafa;font-size:12px}
  .toolbar{display:flex;gap:var(--gap);flex-wrap:wrap;align-items:center}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .list-empty{padding:24px;text-align:center;color:#777}
  .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid #ddd;background:#fff;border-radius:999px;padding:6px 10px;margin:4px 6px 0 0;font-size:12px;cursor:pointer}
  .pill.active{border-color:#222;background:#222;color:#fff}
  .status{font-size:12px;color:#555}
  .status.ok{color:#0a7c2f}
  .status.warn{color:#b8860b}
  .divider{height:1px;background:linear-gradient(90deg,#eee,transparent);margin:10px 0}
</style>
</head>
<body>
  <h1>好词好句收藏夹</h1>

  <!-- 顶部工具栏（含导出/导入/随机/清空 + 登录与同步区） -->
  <div class="card">
    <div class="toolbar">
      <input id="search" placeholder="搜索：句子 / 作者 / 标签…" />
      <div class="actions" style="flex:1 1 280px">
        <button id="exportBtn" class="ghost">导出 JSON</button>
        <input id="importFile" type="file" accept=".json" />
        <button id="randomBtn" class="ghost">来一句 🎲</button>
        <button id="clearBtn" class="ghost" title="清空所有数据（谨慎）">清空</button>
      </div>

      <!-- 登录 & 同步区（可见） -->
      <div class="divider" style="flex-basis:100%"></div>
      <div class="row" style="align-items:center">
        <input id="emailInput" placeholder="邮箱登录以开启云同步（Magic Link）" />
        <button id="loginBtn" class="ghost" style="flex:0 0 140px">发送登录邮件</button>
        <button id="logoutBtn" class="ghost" style="flex:0 0 90px;display:none">退出</button>
        <button id="syncBtn" class="ghost" style="flex:0 0 90px">同步</button>
        <div id="authState" class="status" style="flex:1 1 200px;text-align:right">未登录</div>
      </div>
    </div>
    <div id="tagBar" class="row" style="margin-top:10px"></div>
  </div>

  <!-- 录入区 -->
  <div class="card">
    <div class="row">
      <textarea id="text" placeholder="在此粘贴好词好句…"></textarea>
      <input id="author" placeholder="作者/出处（可选）" />
      <input id="link" placeholder="来源链接（可选）" />
      <input id="tags" placeholder="标签（用逗号分隔）" />
      <select id="tone">
        <option value="">情绪/语气（可选）</option>
        <option>温柔</option><option>激励</option><option>坚韧</option><option>幽默</option><option>清醒</option>
      </select>
      <select id="lang">
        <option value="">语言（可选）</option>
        <option>中文</option><option>English</option><option>日本語</option>
      </select>
      <input id="rating" type="number" min="1" max="5" step="1" placeholder="评分 1-5（可选）" />
    </div>
    <div class="actions" style="margin-top:12px">
      <button id="saveBtn" class="primary">保存</button>
      <button id="resetBtn" class="ghost">重置表单</button>
    </div>
  </div>

  <!-- 列表区 -->
  <div id="list"></div>

<script>
/* ===================== 本地应用逻辑（原有功能） ===================== */
const KEY = "quotes.v1";
const el = id => document.getElementById(id);

const state = {
  items: load(),
  editingId: null,
  activeTag: ""
};

function load(){
  try{ return JSON.parse(localStorage.getItem(KEY)) || []; }
  catch{ return []; }
}
function persist(){ localStorage.setItem(KEY, JSON.stringify(state.items)); }
function uid(){ return Math.random().toString(36).slice(2,10) + Date.now().toString(36); }
function nowISO(){ return new Date().toISOString().slice(0,10); }

function render(){
  renderTagBar();
  const q = el("search").value.trim().toLowerCase();
  const activeTag = state.activeTag;
  const list = el("list");
  list.innerHTML = "";

  let items = [...state.items].sort((a,b)=> (b.createdAt||"").localeCompare(a.createdAt||""));

  if(q){
    items = items.filter(it =>
      (it.text||"").toLowerCase().includes(q) ||
      (it.author||"").toLowerCase().includes(q) ||
      (it.tags||[]).join(",").toLowerCase().includes(q)
    );
  }
  if(activeTag){
    items = items.filter(it => (it.tags||[]).includes(activeTag));
  }

  if(items.length===0){
    const d = document.createElement("div");
    d.className="list-empty";
    d.textContent = "没有内容，先收藏第一句吧 ✨";
    list.appendChild(d);
    return;
  }

  for(const it of items){
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <div class="quote">${escapeHTML(it.text)}</div>
      <div class="muted" style="margin-top:8px">
        ${it.author? `— ${escapeHTML(it.author)}`:""}
        ${it.link? ` · <a href="${it.link}" target="_blank">链接</a>`:""}
        ${it.rating? ` · 评分 ${it.rating}/5`:""}
        ${it.lang? ` · ${it.lang}`:""}
        ${it.tone? ` · ${it.tone}`:""}
        · ${it.createdAt || ""}
      </div>
      <div style="margin-top:6px">${(it.tags||[]).map(t=>`<span class="tag">${escapeHTML(t)}</span>`).join("")}</div>
      <div class="actions" style="margin-top:10px">
        <button data-act="copy" data-id="${it.id}" class="ghost">复制句子</button>
        <button data-act="edit" data-id="${it.id}" class="ghost">编辑</button>
        <button data-act="del" data-id="${it.id}" class="ghost">删除</button>
      </div>
    `;
    list.appendChild(card);
  }
}

function renderTagBar(){
  const all = new Set();
  state.items.forEach(it => (it.tags||[]).forEach(t=> all.add(t)));
  const bar = el("tagBar");
  bar.innerHTML = "";
  if(all.size===0){ return; }
  const mk = (name, active)=> {
    const b = document.createElement("button");
    b.className = "pill" + (active?" active":"");
    b.textContent = name;
    b.onclick = ()=>{ state.activeTag = (state.activeTag===name? "": name); render(); };
    return b;
  };
  bar.appendChild(mk("全部", state.activeTag===""));
  [...all].sort().forEach(t => bar.appendChild(mk(t, state.activeTag===t)));
}

function clearForm(){
  el("text").value="";
  el("author").value="";
  el("link").value="";
  el("tags").value="";
  el("tone").value="";
  el("lang").value="";
  el("rating").value="";
  state.editingId = null;
  el("saveBtn").textContent = "保存";
}

function splitTags(s){ return s.split(",").map(x=>x.trim()).filter(Boolean); }

function saveItem(){
  const text = el("text").value.trim();
  if(!text){ alert("请先填写句子内容"); return; }
  const it = {
    text,
    author: el("author").value.trim(),
    link: el("link").value.trim(),
    tags: splitTags(el("tags").value),
    tone: el("tone").value,
    lang: el("lang").value,
    rating: Number(el("rating").value||""),
  };

  if(state.editingId){
    const idx = state.items.findIndex(x=>x.id===state.editingId);
    if(idx>-1){ state.items[idx] = {...state.items[idx], ...it, updatedAt: new Date().toISOString() }; }
  }else{
    state.items.unshift({ id: uid(), createdAt: nowISO(), updatedAt: new Date().toISOString(), ...it });
  }
  persist();
  clearForm();
  render();
  // —— 云同步队列（在下方 Supabase 段中接管） ——
}

function fillForm(it){
  el("text").value = it.text||"";
  el("author").value = it.author||"";
  el("link").value = it.link||"";
  el("tags").value = (it.tags||[]).join(", ");
  el("tone").value = it.tone||"";
  el("lang").value = it.lang||"";
  el("rating").value = it.rating||"";
  state.editingId = it.id;
  el("saveBtn").textContent = "保存修改";
  window.scrollTo({top:0,behavior:"smooth"});
}

function onListClick(e){
  if(e.target.tagName!=="BUTTON") return;
  const act = e.target.dataset.act;
  const id = e.target.dataset.id;
  const item = state.items.find(x=>x.id===id);
  if(!item) return;

  if(act==="del"){
    if(confirm("确定删除这条收藏吗？")){
      state.items = state.items.filter(x=>x.id!==id);
      persist(); render();
      // —— 云同步队列（在下方 Supabase 段中接管） ——
    }
  }else if(act==="edit"){
    fillForm(item);
  }else if(act==="copy"){
    navigator.clipboard.writeText(item.text).then(()=> {
      e.target.textContent="已复制";
      setTimeout(()=> e.target.textContent="复制句子",1000);
    });
  }
}

function exportJSON(){
  const data = JSON.stringify(state.items, null, 2);
  const blob = new Blob([data], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "quotes-backup.json"; a.click();
  URL.revokeObjectURL(url);
}

function importJSON(file){
  const reader = new FileReader();
  reader.onload = () => {
    try{
      const arr = JSON.parse(reader.result);
      if(!Array.isArray(arr)) throw new Error("格式不正确");
      const map = new Map(state.items.map(x=>[x.id,x]));
      for(const it of arr){ if(it && it.id){ map.set(it.id, it); } }
      state.items = [...map.values()];
      persist(); render();
      alert("导入完成");
    }catch(e){ alert("导入失败："+e.message); }
  };
  reader.readAsText(file);
}

function randomOne(){
  if(state.items.length===0){ alert("还没有内容"); return; }
  const it = state.items[Math.floor(Math.random()*state.items.length)];
  alert((it.text||"") + (it.author? "\n\n— "+it.author:""));
}

function escapeHTML(s){ return (s||"").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

// events
el("saveBtn").onclick = saveItem;
el("resetBtn").onclick = clearForm;
el("list").addEventListener("click", onListClick);
el("search").addEventListener("input", render);
el("exportBtn").onclick = exportJSON;
el("importFile").addEventListener("change", e => e.target.files[0] && importJSON(e.target.files[0]));
el("randomBtn").onclick = randomOne;
el("clearBtn").onclick = ()=> { if(confirm("这会清空本地所有收藏，确定吗？")){ state.items=[]; persist(); render(); } };

render();
</script>

<!-- ===================== Supabase 云同步 ===================== -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/** 1) 初始化 Supabase（你的项目参数） */
const SUPABASE_URL = "https://wwtluqwioyngzawmkvam.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind3dGx1cXdpb3luZ3phd21rdmFtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwMjc4NjEsImV4cCI6MjA3NjYwMzg2MX0.Jog8YR9_5XLK36LBPdzOP2ZXMkMRPhAeith0bPuqw8c";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/** 2) 登录/退出/同步 按钮逻辑 + 状态提示 */
const $login = document.getElementById("loginBtn");
const $logout = document.getElementById("logoutBtn");
const $sync = document.getElementById("syncBtn");
const $email = document.getElementById("emailInput");
const $state = document.getElementById("authState");

$login.onclick = async () => {
  const email = $email.value.trim();
  if(!email) return alert("请输入邮箱");
  const { error } = await sb.auth.signInWithOtp({ email, options:{ emailRedirectTo: location.href }});
  if(error) alert("发送失败："+error.message);
  else alert("登录邮件已发送，请到邮箱点击链接完成登录。");
};
$logout.onclick = async () => { await sb.auth.signOut(); setAuthUI(null); };
$sync.onclick = syncNow;

sb.auth.onAuthStateChange((_evt, sess)=> setAuthUI(sess?.user || null));
(async () => { const s = await sb.auth.getSession(); setAuthUI(s.data.session?.user||null); })();

function setAuthUI(user){
  if(user){
    $login.style.display="none"; $logout.style.display=""; $email.style.display="none";
    $state.textContent = `已登录：${user.email}`; $state.className="status ok";
    syncNow(); // 登录后自动同步一次
  }else{
    $login.style.display=""; $logout.style.display="none"; $email.style.display="";
    $state.textContent = "未登录"; $state.className="status warn";
  }
}

/** 3) 离线队列：保存/删除动作入队，待同步 */
const QUEUE_KEY = "quotes.queue.v1";
const getQueue = ()=> { try{return JSON.parse(localStorage.getItem(QUEUE_KEY))||[]}catch{return[]} };
const setQueue = q => localStorage.setItem(QUEUE_KEY, JSON.stringify(q));

const _saveItemRaw = saveItem;
saveItem = function(){
  const before = JSON.stringify(state.items||[]);
  _saveItemRaw();
  const after = JSON.parse(JSON.stringify(state.items||[]));
  const beforeSet = new Set(JSON.parse(before).map(x=>x.id));
  const diff = after.find(x=>!beforeSet.has(x.id)) || after[0];
  if(diff){
    diff.updatedAt = new Date().toISOString();
    const q = getQueue(); q.push({op:"upsert", row:diff}); setQueue(q);
  }
};
document.addEventListener("click", (e)=>{
  if(e.target?.dataset?.act === "del"){
    const id = e.target.dataset.id;
    const q = getQueue(); q.push({op:"delete", id, updatedAt:new Date().toISOString()}); setQueue(q);
  }
}, true);

/** 4) 同步：本地与云端合并，谁新用谁（last-write-wins） */
async function syncNow(){
  const sess = await sb.auth.getSession();
  const user = sess?.data?.session?.user;
  if(!user){ alert("请先登录邮箱以开启同步"); return; }

  // 4.1 拉取云端
  const { data:remote, error } = await sb.from("quotes").select("*").order("updated_at",{ascending:false});
  if(error){ console.error(error); alert("云端拉取失败："+error.message); return; }

  // 4.2 合并
  const local = load();
  const map = new Map(); // id -> row（混合本地/远端结构）
  const put = (r)=>{ if(!r?.id) return;
    const existed = map.get(r.id);
    const a = (r.updatedAt||r.updated_at||r.createdAt||r.created_at||"");
    const b = existed&&(existed.updatedAt||existed.updated_at||existed.createdAt||existed.created_at||"");
    if(!existed || a>b) map.set(r.id, r);
  };
  remote.forEach(put); local.forEach(put);

  // 4.3 上行离线队列
  const q = getQueue();
  for(const item of q){
    if(item.op==="upsert"){
      const row = normalizeRow(item.row);
      const { error:e1 } = await sb.from("quotes").upsert(row, { onConflict:"id" });
      if(e1) console.error(e1); else put(row);
    }else if(item.op==="delete"){
      const { error:e2 } = await sb.from("quotes").update({ deleted:true }).eq("id", item.id);
      if(e2) console.error(e2); else map.delete(item.id);
    }
  }
  setQueue([]);

  // 4.4 落回本地并刷新
  state.items = [...map.values()].filter(r=>!r.deleted).map(fromRemote);
  persist(); render();
  console.log("Sync done");
}

/** 结构转换：前端 <-> 数据库 */
function normalizeRow(it){
  return {
    id: it.id,
    text: it.text,
    author: it.author || null,
    link: it.link || null,
    tags: (it.tags||[]).filter(Boolean),
    tone: it.tone || null,
    lang: it.lang || null,
    rating: (typeof it.rating==="number" && !Number.isNaN(it.rating)) ? it.rating : null,
    created_at: it.createdAt ? new Date(it.createdAt).toISOString() : new Date().toISOString(),
    updated_at: it.updatedAt ? new Date(it.updatedAt).toISOString() : new Date().toISOString(),
    deleted: false
  };
}
function fromRemote(r){
  return {
    id: r.id,
    text: r.text,
    author: r.author || "",
    link: r.link || "",
    tags: r.tags || [],
    tone: r.tone || "",
    lang: r.lang || "",
    rating: r.rating || "",
    createdAt: r.created_at ? r.created_at.slice(0,10) : "",
    updatedAt: r.updated_at || r.created_at,
    deleted: !!r.deleted
  };
}

/** 5) 自动每 5 分钟同步一次（登录后） */
setInterval(async ()=>{
  const s = await sb.auth.getSession();
  if(s?.data?.session?.user){ syncNow(); }
}, 5*60*1000);
</script>
</body>
</html>
