<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å¥½è¯å¥½å¥æ”¶è—å¤¹</title>
<style>
  :root{--gap:12px;--radius:12px}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;max-width:980px;margin:0 auto;padding:24px;background:#f7f7fb;color:#222}
  h1{font-size:22px;margin:0 0 16px}
  .card{background:#fff;border-radius:var(--radius);padding:16px;box-shadow:0 2px 10px rgba(0,0,0,.06);margin-bottom:var(--gap)}
  .row{display:flex;gap:var(--gap);flex-wrap:wrap}
  .row>*{flex:1 1 260px}
  input,textarea,select,button{width:100%;padding:10px 12px;border:1px solid #ddd;border-radius:10px;background:#fff;font-size:14px}
  textarea{min-height:80px;resize:vertical}
  button{cursor:pointer}
  button.primary{background:#222;color:#fff;border-color:#222}
  button.ghost{background:#fff}
  .quote{white-space:pre-wrap;line-height:1.6}
  .muted{color:#666;font-size:12px}
  .tag{display:inline-block;padding:2px 8px;border:1px solid #ddd;border-radius:999px;margin-right:6px;margin-top:6px;background:#fafafa;font-size:12px}
  .toolbar{display:flex;gap:var(--gap);flex-wrap:wrap;align-items:center}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .list-empty{padding:24px;text-align:center;color:#777}
  .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid #ddd;background:#fff;border-radius:999px;padding:6px 10px;margin:4px 6px 0 0;font-size:12px;cursor:pointer}
  .pill.active{border-color:#222;background:#222;color:#fff}
  .status{font-size:12px;color:#555}
  .status.ok{color:#0a7c2f}
  .status.warn{color:#b8860b}
  .divider{height:1px;background:linear-gradient(90deg,#eee,transparent);margin:10px 0}
</style>
</head>
<body>
  <h1>å¥½è¯å¥½å¥æ”¶è—å¤¹</h1>

  <!-- é¡¶éƒ¨å·¥å…·æ ï¼ˆå«å¯¼å‡º/å¯¼å…¥/éšæœº/æ¸…ç©º + ç™»å½•ä¸åŒæ­¥åŒºï¼‰ -->
  <div class="card">
    <div class="toolbar">
      <input id="search" placeholder="æœç´¢ï¼šå¥å­ / ä½œè€… / æ ‡ç­¾â€¦" />
      <div class="actions" style="flex:1 1 280px">
        <button id="exportBtn" class="ghost">å¯¼å‡º JSON</button>
        <input id="importFile" type="file" accept=".json" />
        <button id="randomBtn" class="ghost">æ¥ä¸€å¥ ğŸ²</button>
        <button id="clearBtn" class="ghost" title="æ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼ˆè°¨æ…ï¼‰">æ¸…ç©º</button>
      </div>

      <!-- ç™»å½• & åŒæ­¥åŒºï¼ˆå¯è§ï¼‰ -->
      <div class="divider" style="flex-basis:100%"></div>
      <div class="row" style="align-items:center">
        <input id="emailInput" placeholder="é‚®ç®±ç™»å½•ä»¥å¼€å¯äº‘åŒæ­¥ï¼ˆMagic Linkï¼‰" />
        <button id="loginBtn" class="ghost" style="flex:0 0 140px">å‘é€ç™»å½•é‚®ä»¶</button>
        <button id="logoutBtn" class="ghost" style="flex:0 0 90px;display:none">é€€å‡º</button>
        <button id="syncBtn" class="ghost" style="flex:0 0 90px">åŒæ­¥</button>
        <div id="authState" class="status" style="flex:1 1 200px;text-align:right">æœªç™»å½•</div>
      </div>
    </div>
    <div id="tagBar" class="row" style="margin-top:10px"></div>
  </div>

  <!-- å½•å…¥åŒº -->
  <div class="card">
    <div class="row">
      <textarea id="text" placeholder="åœ¨æ­¤ç²˜è´´å¥½è¯å¥½å¥â€¦"></textarea>
      <input id="author" placeholder="ä½œè€…/å‡ºå¤„ï¼ˆå¯é€‰ï¼‰" />
      <input id="link" placeholder="æ¥æºé“¾æ¥ï¼ˆå¯é€‰ï¼‰" />
      <input id="tags" placeholder="æ ‡ç­¾ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰" />
      <select id="tone">
        <option value="">æƒ…ç»ª/è¯­æ°”ï¼ˆå¯é€‰ï¼‰</option>
        <option>æ¸©æŸ”</option><option>æ¿€åŠ±</option><option>åšéŸ§</option><option>å¹½é»˜</option><option>æ¸…é†’</option>
      </select>
      <select id="lang">
        <option value="">è¯­è¨€ï¼ˆå¯é€‰ï¼‰</option>
        <option>ä¸­æ–‡</option><option>English</option><option>æ—¥æœ¬èª</option>
      </select>
      <input id="rating" type="number" min="1" max="5" step="1" placeholder="è¯„åˆ† 1-5ï¼ˆå¯é€‰ï¼‰" />
    </div>
    <div class="actions" style="margin-top:12px">
      <button id="saveBtn" class="primary">ä¿å­˜</button>
      <button id="resetBtn" class="ghost">é‡ç½®è¡¨å•</button>
    </div>
  </div>

  <!-- åˆ—è¡¨åŒº -->
  <div id="list"></div>

<script>
/* ===================== æœ¬åœ°åº”ç”¨é€»è¾‘ï¼ˆåŸæœ‰åŠŸèƒ½ï¼‰ ===================== */
const KEY = "quotes.v1";
const el = id => document.getElementById(id);

const state = {
  items: load(),
  editingId: null,
  activeTag: ""
};

function load(){
  try{ return JSON.parse(localStorage.getItem(KEY)) || []; }
  catch{ return []; }
}
function persist(){ localStorage.setItem(KEY, JSON.stringify(state.items)); }
function uid(){ return Math.random().toString(36).slice(2,10) + Date.now().toString(36); }
function nowISO(){ return new Date().toISOString().slice(0,10); }

function render(){
  renderTagBar();
  const q = el("search").value.trim().toLowerCase();
  const activeTag = state.activeTag;
  const list = el("list");
  list.innerHTML = "";

  let items = [...state.items].sort((a,b)=> (b.createdAt||"").localeCompare(a.createdAt||""));

  if(q){
    items = items.filter(it =>
      (it.text||"").toLowerCase().includes(q) ||
      (it.author||"").toLowerCase().includes(q) ||
      (it.tags||[]).join(",").toLowerCase().includes(q)
    );
  }
  if(activeTag){
    items = items.filter(it => (it.tags||[]).includes(activeTag));
  }

  if(items.length===0){
    const d = document.createElement("div");
    d.className="list-empty";
    d.textContent = "æ²¡æœ‰å†…å®¹ï¼Œå…ˆæ”¶è—ç¬¬ä¸€å¥å§ âœ¨";
    list.appendChild(d);
    return;
  }

  for(const it of items){
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <div class="quote">${escapeHTML(it.text)}</div>
      <div class="muted" style="margin-top:8px">
        ${it.author? `â€” ${escapeHTML(it.author)}`:""}
        ${it.link? ` Â· <a href="${it.link}" target="_blank">é“¾æ¥</a>`:""}
        ${it.rating? ` Â· è¯„åˆ† ${it.rating}/5`:""}
        ${it.lang? ` Â· ${it.lang}`:""}
        ${it.tone? ` Â· ${it.tone}`:""}
        Â· ${it.createdAt || ""}
      </div>
      <div style="margin-top:6px">${(it.tags||[]).map(t=>`<span class="tag">${escapeHTML(t)}</span>`).join("")}</div>
      <div class="actions" style="margin-top:10px">
        <button data-act="copy" data-id="${it.id}" class="ghost">å¤åˆ¶å¥å­</button>
        <button data-act="edit" data-id="${it.id}" class="ghost">ç¼–è¾‘</button>
        <button data-act="del" data-id="${it.id}" class="ghost">åˆ é™¤</button>
      </div>
    `;
    list.appendChild(card);
  }
}

function renderTagBar(){
  const all = new Set();
  state.items.forEach(it => (it.tags||[]).forEach(t=> all.add(t)));
  const bar = el("tagBar");
  bar.innerHTML = "";
  if(all.size===0){ return; }
  const mk = (name, active)=> {
    const b = document.createElement("button");
    b.className = "pill" + (active?" active":"");
    b.textContent = name;
    b.onclick = ()=>{ state.activeTag = (state.activeTag===name? "": name); render(); };
    return b;
  };
  bar.appendChild(mk("å…¨éƒ¨", state.activeTag===""));
  [...all].sort().forEach(t => bar.appendChild(mk(t, state.activeTag===t)));
}

function clearForm(){
  el("text").value="";
  el("author").value="";
  el("link").value="";
  el("tags").value="";
  el("tone").value="";
  el("lang").value="";
  el("rating").value="";
  state.editingId = null;
  el("saveBtn").textContent = "ä¿å­˜";
}

function splitTags(s){ return s.split(",").map(x=>x.trim()).filter(Boolean); }

function saveItem(){
  const text = el("text").value.trim();
  if(!text){ alert("è¯·å…ˆå¡«å†™å¥å­å†…å®¹"); return; }
  const it = {
    text,
    author: el("author").value.trim(),
    link: el("link").value.trim(),
    tags: splitTags(el("tags").value),
    tone: el("tone").value,
    lang: el("lang").value,
    rating: Number(el("rating").value||""),
  };

  if(state.editingId){
    const idx = state.items.findIndex(x=>x.id===state.editingId);
    if(idx>-1){ state.items[idx] = {...state.items[idx], ...it, updatedAt: new Date().toISOString() }; }
  }else{
    state.items.unshift({ id: uid(), createdAt: nowISO(), updatedAt: new Date().toISOString(), ...it });
  }
  persist();
  clearForm();
  render();
  // â€”â€” äº‘åŒæ­¥é˜Ÿåˆ—ï¼ˆåœ¨ä¸‹æ–¹ Supabase æ®µä¸­æ¥ç®¡ï¼‰ â€”â€”
}

function fillForm(it){
  el("text").value = it.text||"";
  el("author").value = it.author||"";
  el("link").value = it.link||"";
  el("tags").value = (it.tags||[]).join(", ");
  el("tone").value = it.tone||"";
  el("lang").value = it.lang||"";
  el("rating").value = it.rating||"";
  state.editingId = it.id;
  el("saveBtn").textContent = "ä¿å­˜ä¿®æ”¹";
  window.scrollTo({top:0,behavior:"smooth"});
}

function onListClick(e){
  if(e.target.tagName!=="BUTTON") return;
  const act = e.target.dataset.act;
  const id = e.target.dataset.id;
  const item = state.items.find(x=>x.id===id);
  if(!item) return;

  if(act==="del"){
    if(confirm("ç¡®å®šåˆ é™¤è¿™æ¡æ”¶è—å—ï¼Ÿ")){
      state.items = state.items.filter(x=>x.id!==id);
      persist(); render();
      // â€”â€” äº‘åŒæ­¥é˜Ÿåˆ—ï¼ˆåœ¨ä¸‹æ–¹ Supabase æ®µä¸­æ¥ç®¡ï¼‰ â€”â€”
    }
  }else if(act==="edit"){
    fillForm(item);
  }else if(act==="copy"){
    navigator.clipboard.writeText(item.text).then(()=> {
      e.target.textContent="å·²å¤åˆ¶";
      setTimeout(()=> e.target.textContent="å¤åˆ¶å¥å­",1000);
    });
  }
}

function exportJSON(){
  const data = JSON.stringify(state.items, null, 2);
  const blob = new Blob([data], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "quotes-backup.json"; a.click();
  URL.revokeObjectURL(url);
}

function importJSON(file){
  const reader = new FileReader();
  reader.onload = () => {
    try{
      const arr = JSON.parse(reader.result);
      if(!Array.isArray(arr)) throw new Error("æ ¼å¼ä¸æ­£ç¡®");
      const map = new Map(state.items.map(x=>[x.id,x]));
      for(const it of arr){ if(it && it.id){ map.set(it.id, it); } }
      state.items = [...map.values()];
      persist(); render();
      alert("å¯¼å…¥å®Œæˆ");
    }catch(e){ alert("å¯¼å…¥å¤±è´¥ï¼š"+e.message); }
  };
  reader.readAsText(file);
}

function randomOne(){
  if(state.items.length===0){ alert("è¿˜æ²¡æœ‰å†…å®¹"); return; }
  const it = state.items[Math.floor(Math.random()*state.items.length)];
  alert((it.text||"") + (it.author? "\n\nâ€” "+it.author:""));
}

function escapeHTML(s){ return (s||"").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

// events
el("saveBtn").onclick = saveItem;
el("resetBtn").onclick = clearForm;
el("list").addEventListener("click", onListClick);
el("search").addEventListener("input", render);
el("exportBtn").onclick = exportJSON;
el("importFile").addEventListener("change", e => e.target.files[0] && importJSON(e.target.files[0]));
el("randomBtn").onclick = randomOne;
el("clearBtn").onclick = ()=> { if(confirm("è¿™ä¼šæ¸…ç©ºæœ¬åœ°æ‰€æœ‰æ”¶è—ï¼Œç¡®å®šå—ï¼Ÿ")){ state.items=[]; persist(); render(); } };

render();
</script>

<!-- ===================== Supabase äº‘åŒæ­¥ ===================== -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/** 1) åˆå§‹åŒ– Supabaseï¼ˆä½ çš„é¡¹ç›®å‚æ•°ï¼‰ */
const SUPABASE_URL = "https://wwtluqwioyngzawmkvam.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind3dGx1cXdpb3luZ3phd21rdmFtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwMjc4NjEsImV4cCI6MjA3NjYwMzg2MX0.Jog8YR9_5XLK36LBPdzOP2ZXMkMRPhAeith0bPuqw8c";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/** 2) ç™»å½•/é€€å‡º/åŒæ­¥ æŒ‰é’®é€»è¾‘ + çŠ¶æ€æç¤º */
const $login = document.getElementById("loginBtn");
const $logout = document.getElementById("logoutBtn");
const $sync = document.getElementById("syncBtn");
const $email = document.getElementById("emailInput");
const $state = document.getElementById("authState");

$login.onclick = async () => {
  const email = $email.value.trim();
  if(!email) return alert("è¯·è¾“å…¥é‚®ç®±");
  const { error } = await sb.auth.signInWithOtp({ email, options:{ emailRedirectTo: location.href }});
  if(error) alert("å‘é€å¤±è´¥ï¼š"+error.message);
  else alert("ç™»å½•é‚®ä»¶å·²å‘é€ï¼Œè¯·åˆ°é‚®ç®±ç‚¹å‡»é“¾æ¥å®Œæˆç™»å½•ã€‚");
};
$logout.onclick = async () => { await sb.auth.signOut(); setAuthUI(null); };
$sync.onclick = syncNow;

sb.auth.onAuthStateChange((_evt, sess)=> setAuthUI(sess?.user || null));
(async () => { const s = await sb.auth.getSession(); setAuthUI(s.data.session?.user||null); })();

function setAuthUI(user){
  if(user){
    $login.style.display="none"; $logout.style.display=""; $email.style.display="none";
    $state.textContent = `å·²ç™»å½•ï¼š${user.email}`; $state.className="status ok";
    syncNow(); // ç™»å½•åè‡ªåŠ¨åŒæ­¥ä¸€æ¬¡
  }else{
    $login.style.display=""; $logout.style.display="none"; $email.style.display="";
    $state.textContent = "æœªç™»å½•"; $state.className="status warn";
  }
}

/** 3) ç¦»çº¿é˜Ÿåˆ—ï¼šä¿å­˜/åˆ é™¤åŠ¨ä½œå…¥é˜Ÿï¼Œå¾…åŒæ­¥ */
const QUEUE_KEY = "quotes.queue.v1";
const getQueue = ()=> { try{return JSON.parse(localStorage.getItem(QUEUE_KEY))||[]}catch{return[]} };
const setQueue = q => localStorage.setItem(QUEUE_KEY, JSON.stringify(q));

const _saveItemRaw = saveItem;
saveItem = function(){
  const before = JSON.stringify(state.items||[]);
  _saveItemRaw();
  const after = JSON.parse(JSON.stringify(state.items||[]));
  const beforeSet = new Set(JSON.parse(before).map(x=>x.id));
  const diff = after.find(x=>!beforeSet.has(x.id)) || after[0];
  if(diff){
    diff.updatedAt = new Date().toISOString();
    const q = getQueue(); q.push({op:"upsert", row:diff}); setQueue(q);
  }
};
document.addEventListener("click", (e)=>{
  if(e.target?.dataset?.act === "del"){
    const id = e.target.dataset.id;
    const q = getQueue(); q.push({op:"delete", id, updatedAt:new Date().toISOString()}); setQueue(q);
  }
}, true);

/** 4) åŒæ­¥ï¼šæœ¬åœ°ä¸äº‘ç«¯åˆå¹¶ï¼Œè°æ–°ç”¨è°ï¼ˆlast-write-winsï¼‰ */
async function syncNow(){
  const sess = await sb.auth.getSession();
  const user = sess?.data?.session?.user;
  if(!user){ alert("è¯·å…ˆç™»å½•é‚®ç®±ä»¥å¼€å¯åŒæ­¥"); return; }

  // 4.1 æ‹‰å–äº‘ç«¯
  const { data:remote, error } = await sb.from("quotes").select("*").order("updated_at",{ascending:false});
  if(error){ console.error(error); alert("äº‘ç«¯æ‹‰å–å¤±è´¥ï¼š"+error.message); return; }

  // 4.2 åˆå¹¶
  const local = load();
  const map = new Map(); // id -> rowï¼ˆæ··åˆæœ¬åœ°/è¿œç«¯ç»“æ„ï¼‰
  const put = (r)=>{ if(!r?.id) return;
    const existed = map.get(r.id);
    const a = (r.updatedAt||r.updated_at||r.createdAt||r.created_at||"");
    const b = existed&&(existed.updatedAt||existed.updated_at||existed.createdAt||existed.created_at||"");
    if(!existed || a>b) map.set(r.id, r);
  };
  remote.forEach(put); local.forEach(put);

  // 4.3 ä¸Šè¡Œç¦»çº¿é˜Ÿåˆ—
  const q = getQueue();
  for(const item of q){
    if(item.op==="upsert"){
      const row = normalizeRow(item.row);
      const { error:e1 } = await sb.from("quotes").upsert(row, { onConflict:"id" });
      if(e1) console.error(e1); else put(row);
    }else if(item.op==="delete"){
      const { error:e2 } = await sb.from("quotes").update({ deleted:true }).eq("id", item.id);
      if(e2) console.error(e2); else map.delete(item.id);
    }
  }
  setQueue([]);

  // 4.4 è½å›æœ¬åœ°å¹¶åˆ·æ–°
  state.items = [...map.values()].filter(r=>!r.deleted).map(fromRemote);
  persist(); render();
  console.log("Sync done");
}

/** ç»“æ„è½¬æ¢ï¼šå‰ç«¯ <-> æ•°æ®åº“ */
function normalizeRow(it){
  return {
    id: it.id,
    text: it.text,
    author: it.author || null,
    link: it.link || null,
    tags: (it.tags||[]).filter(Boolean),
    tone: it.tone || null,
    lang: it.lang || null,
    rating: (typeof it.rating==="number" && !Number.isNaN(it.rating)) ? it.rating : null,
    created_at: it.createdAt ? new Date(it.createdAt).toISOString() : new Date().toISOString(),
    updated_at: it.updatedAt ? new Date(it.updatedAt).toISOString() : new Date().toISOString(),
    deleted: false
  };
}
function fromRemote(r){
  return {
    id: r.id,
    text: r.text,
    author: r.author || "",
    link: r.link || "",
    tags: r.tags || [],
    tone: r.tone || "",
    lang: r.lang || "",
    rating: r.rating || "",
    createdAt: r.created_at ? r.created_at.slice(0,10) : "",
    updatedAt: r.updated_at || r.created_at,
    deleted: !!r.deleted
  };
}

/** 5) è‡ªåŠ¨æ¯ 5 åˆ†é’ŸåŒæ­¥ä¸€æ¬¡ï¼ˆç™»å½•åï¼‰ */
setInterval(async ()=>{
  const s = await sb.auth.getSession();
  if(s?.data?.session?.user){ syncNow(); }
}, 5*60*1000);
</script>
</body>
</html>
