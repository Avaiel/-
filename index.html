<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å¥½è¯å¥½å¥æ”¶è—å¤¹</title>
<style>
  :root{
    --gap:14px; --radius:14px; --primary:#4b7bec; --bg:#f7f9fc; --card:#fff; --text:#222; --muted:#666; --line:#e8ebf2;
  }
  [data-theme="dark"]{
    --bg:#0f172a; --card:#111827; --text:#e5e7eb; --muted:#9ca3af; --line:#273246; --primary:#7aa2ff;
  }
  html,body{height:100%}
  body{
    font-family:"Inter","Noto Sans SC",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    background:var(--bg); color:var(--text);
    max-width:980px;margin:0 auto;padding:16px;
  }
  .nav{
    display:flex;align-items:center;gap:12px;
    background:var(--card); border-radius:16px; padding:10px 14px; margin:8px 0 16px;
    box-shadow:0 4px 14px rgba(0,0,0,.06); position:sticky; top:8px; z-index:5;
  }
  .brand{display:flex;align-items:center;gap:10px}
  .logo{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,var(--primary),#64b5f6)}
  .title{font-weight:700}
  .nav-right{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap}
  .btn{border:1px solid var(--line); background:transparent; color:var(--text);
    border-radius:10px; padding:8px 12px; font-size:14px; cursor:pointer; transition:.2s}
  .btn:hover{border-color:var(--primary); color:var(--primary)}
  .btn.primary{background:var(--primary); color:#fff; border-color:transparent}
  .btn.primary:hover{opacity:.95}
  .btn.icon{width:40px;height:36px;display:flex;align-items:center;justify-content:center}
  h1{display:none}
  .card{
    background:var(--card); border-radius:var(--radius);
    padding:20px; margin-bottom:var(--gap);
    box-shadow:0 4px 12px rgba(0,0,0,.08);
    transition:transform .2s, box-shadow .2s;
  }
  .card:hover{transform:translateY(-1px); box-shadow:0 8px 22px rgba(0,0,0,.08)}
  .row{display:flex;gap:var(--gap);flex-wrap:wrap}
  .row>*{flex:1 1 260px}
  input,textarea,select,button{
    width:100%; padding:10px 12px; border:1px solid var(--line); border-radius:10px;
    background:transparent; color:var(--text); font-size:14px; transition:border .2s, box-shadow .2s
  }
  input:focus,textarea:focus,select:focus{border-color:var(--primary); box-shadow:0 0 0 2px color-mix(in srgb,var(--primary) 30%, transparent); outline:none}
  textarea{min-height:90px; resize:vertical}
  a{color:var(--primary); text-decoration:none}
  a:hover{text-decoration:underline}
  .toolbar{display:flex;gap:var(--gap);flex-wrap:wrap;align-items:center}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .divider{height:1px;background:linear-gradient(90deg,var(--line),transparent);margin:10px 0}
  .status{font-size:12px;color:var(--muted)}
  .status.ok{color:#22c55e}
  .status.warn{color:#eab308}
  .quote{white-space:pre-wrap; line-height:1.7}
  .muted{color:var(--muted); font-size:12px}
  .tag{display:inline-block;padding:3px 8px;border:1px solid var(--line);border-radius:999px;margin-right:6px;margin-top:6px;background:color-mix(in srgb,var(--line) 40%, transparent); font-size:12px}
  .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);background:transparent;border-radius:999px;padding:6px 10px;margin:4px 6px 0 0;font-size:12px;cursor:pointer}
  .pill.active{border-color:var(--primary); background:color-mix(in srgb,var(--primary) 20%, transparent); color:var(--text)}
  .list-empty{padding:24px;text-align:center;color:var(--muted)}
  @media (max-width: 640px){
    body{padding:10px}
    .row>*{flex:1 1 100%}
    .nav-right{gap:6px}
  }
</style>
</head>
<body>

  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <div class="nav">
    <div class="brand">
      <div class="logo"></div>
      <div class="title">å¥½è¯å¥½å¥æ”¶è—å¤¹</div>
    </div>
    <div class="nav-right">
      <button id="toggleTheme" class="btn icon" title="æ·±æµ…è‰²åˆ‡æ¢">ğŸŒ™</button>
      <button id="navSync" class="btn">åŒæ­¥</button>
      <button id="navExport" class="btn">å¯¼å‡º</button>
      <label class="btn" for="navImportFile">å¯¼å…¥</label>
      <input id="navImportFile" type="file" accept=".json" style="display:none" />
    </div>
  </div>

  <!-- é¡¶éƒ¨å·¥å…·æ ï¼ˆæœç´¢ã€å¤‡ä»½ã€éšæœºã€æ¸…ç©º + ç™»å½•ï¼‰ -->
  <div class="card">
    <div class="toolbar">
      <input id="search" placeholder="æœç´¢ï¼šå¥å­ / ä½œè€… / æ ‡ç­¾â€¦" />
      <div class="actions" style="flex:1 1 280px">
        <button id="exportBtn" class="btn">å¯¼å‡º JSON</button>
        <input id="importFile" type="file" accept=".json" />
        <button id="randomBtn" class="btn">æ¥ä¸€å¥ ğŸ²</button>
        <button id="clearBtn" class="btn" title="æ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼ˆè°¨æ…ï¼‰">æ¸…ç©º</button>
      </div>

      <div class="divider" style="flex-basis:100%"></div>

      <!-- ç™»å½• & åŒæ­¥åŒºï¼ˆæ–¹æ¡ˆBï¼šé‚®ç®±+å¯†ç ï¼‰ -->
      <div class="row" style="align-items:center">
        <input id="emailInput" placeholder="é‚®ç®±ï¼ˆç”¨äºç™»å½•/æ³¨å†Œï¼‰" />
        <input id="passwordInput" type="password" placeholder="å¯†ç ï¼ˆé¦–æ¬¡å¯è‡ªå®šä¹‰ï¼‰" />
        <button id="signupBtn" class="btn" style="flex:0 0 90px">æ³¨å†Œ</button>
        <button id="loginBtn" class="btn" style="flex:0 0 90px">ç™»å½•</button>

        <!-- ä¿ç•™é‚®ä»¶ç™»å½•å¤‡é€‰ï¼ˆå¯åˆ é™¤è¿™ä¸¤è¡Œï¼‰ -->
        <button id="linkLoginBtn" class="btn" style="flex:0 0 120px">é‚®ä»¶ç™»å½•</button>

        <button id="logoutBtn" class="btn" style="flex:0 0 90px;display:none">é€€å‡º</button>
        <button id="syncBtn" class="btn" style="flex:0 0 90px">åŒæ­¥</button>
        <div id="authState" class="status" style="flex:1 1 200px;text-align:right">æœªç™»å½•</div>
      </div>
    </div>
    <div id="tagBar" class="row" style="margin-top:10px"></div>
  </div>

  <!-- å½•å…¥ -->
  <div class="card">
    <div class="row">
      <textarea id="text" placeholder="åœ¨æ­¤ç²˜è´´å¥½è¯å¥½å¥â€¦"></textarea>
      <input id="author" placeholder="ä½œè€…/å‡ºå¤„ï¼ˆå¯é€‰ï¼‰" />
      <input id="link" placeholder="æ¥æºé“¾æ¥ï¼ˆå¯é€‰ï¼‰" />
      <input id="tags" placeholder="æ ‡ç­¾ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰" />
      <select id="tone">
        <option value="">æƒ…ç»ª/è¯­æ°”ï¼ˆå¯é€‰ï¼‰</option>
        <option>æ¸©æŸ”</option><option>æ¿€åŠ±</option><option>åšéŸ§</option><option>å¹½é»˜</option><option>æ¸…é†’</option>
      </select>
      <select id="lang">
        <option value="">è¯­è¨€ï¼ˆå¯é€‰ï¼‰</option>
        <option>ä¸­æ–‡</option><option>English</option><option>æ—¥æœ¬èª</option>
      </select>
      <input id="rating" type="number" min="1" max="5" step="1" placeholder="è¯„åˆ† 1-5ï¼ˆå¯é€‰ï¼‰" />
    </div>
    <div class="actions" style="margin-top:12px">
      <button id="saveBtn" class="btn primary">ä¿å­˜</button>
      <button id="resetBtn" class="btn">é‡ç½®è¡¨å•</button>
    </div>
  </div>

  <!-- åˆ—è¡¨ -->
  <div id="list"></div>

<script>
/* ä¸»é¢˜åˆ‡æ¢ï¼ˆè®°å¿†ï¼‰ */
const themeToggleBtn = document.getElementById('toggleTheme');
const THEME_KEY = 'quotes.theme';
const applyTheme = (t)=>{ document.documentElement.setAttribute('data-theme', t); themeToggleBtn.textContent = t==='dark'?'â˜€ï¸':'ğŸŒ™'; localStorage.setItem(THEME_KEY,t); };
applyTheme(localStorage.getItem(THEME_KEY)|| (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark':'light'));
themeToggleBtn.onclick = ()=> applyTheme(document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark');

/* æœ¬åœ°åº”ç”¨é€»è¾‘ï¼ˆåŸæœ‰åŠŸèƒ½ï¼‰ */
const KEY = "quotes.v1";
const el = id => document.getElementById(id);

const state = { items: load(), editingId: null, activeTag: "" };

function load(){ try{ return JSON.parse(localStorage.getItem(KEY)) || []; } catch{ return []; } }
function persist(){ localStorage.setItem(KEY, JSON.stringify(state.items)); }
function uid(){ return Math.random().toString(36).slice(2,10) + Date.now().toString(36); }
function nowISO(){ return new Date().toISOString().slice(0,10); }

function render(){
  renderTagBar();
  const q = el("search").value.trim().toLowerCase();
  const activeTag = state.activeTag;
  const list = el("list"); list.innerHTML = "";
  let items = [...state.items].sort((a,b)=> (b.createdAt||"").localeCompare(a.createdAt||""));
  if(q){ items = items.filter(it =>
    (it.text||"").toLowerCase().includes(q) ||
    (it.author||"").toLowerCase().includes(q) ||
    (it.tags||[]).join(",").toLowerCase().includes(q)
  );}
  if(activeTag){ items = items.filter(it => (it.tags||[]).includes(activeTag)); }
  if(items.length===0){ const d = document.createElement("div"); d.className="list-empty"; d.textContent = "æ²¡æœ‰å†…å®¹ï¼Œå…ˆæ”¶è—ç¬¬ä¸€å¥å§ âœ¨"; list.appendChild(d); return; }
  for(const it of items){
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <div class="quote">${escapeHTML(it.text)}</div>
      <div class="muted" style="margin-top:8px">
        ${it.author? `â€” ${escapeHTML(it.author)}`:""}
        ${it.link? ` Â· <a href="${it.link}" target="_blank" rel="noopener">é“¾æ¥</a>`:""}
        ${it.rating? ` Â· è¯„åˆ† ${it.rating}/5`:""}
        ${it.lang? ` Â· ${it.lang}`:""}
        ${it.tone? ` Â· ${it.tone}`:""}
        Â· ${it.createdAt || ""}
      </div>
      <div style="margin-top:6px">${(it.tags||[]).map(t=>`<span class="tag">${escapeHTML(t)}</span>`).join("")}</div>
      <div class="actions" style="margin-top:10px">
        <button data-act="copy" data-id="${it.id}" class="btn">å¤åˆ¶å¥å­</button>
        <button data-act="edit" data-id="${it.id}" class="btn">ç¼–è¾‘</button>
        <button data-act="del" data-id="${it.id}" class="btn">åˆ é™¤</button>
      </div>
    `;
    list.appendChild(card);
  }
}

function renderTagBar(){
  const all = new Set(); state.items.forEach(it => (it.tags||[]).forEach(t=> all.add(t)));
  const bar = el("tagBar"); bar.innerHTML = ""; if(all.size===0) return;
  const mk = (name, active)=> { const b = document.createElement("button"); b.className = "pill" + (active?" active":""); b.textContent = name; b.onclick = ()=>{ state.activeTag = (state.activeTag===name? "": name); render(); }; return b; };
  bar.appendChild(mk("å…¨éƒ¨", state.activeTag==="")); [...all].sort().forEach(t => bar.appendChild(mk(t, state.activeTag===t)));
}

function clearForm(){ el("text").value=""; el("author").value=""; el("link").value=""; el("tags").value=""; el("tone").value=""; el("lang").value=""; el("rating").value=""; state.editingId=null; el("saveBtn").textContent="ä¿å­˜"; }
function splitTags(s){ return s.split(",").map(x=>x.trim()).filter(Boolean); }

function saveItem(){
  const text = el("text").value.trim(); if(!text){ alert("è¯·å…ˆå¡«å†™å¥å­å†…å®¹"); return; }
  const it = {
    text, author: el("author").value.trim(), link: el("link").value.trim(),
    tags: splitTags(el("tags").value), tone: el("tone").value, lang: el("lang").value,
    rating: Number(el("rating").value||""),
  };
  if(state.editingId){ const idx = state.items.findIndex(x=>x.id===state.editingId); if(idx>-1){ state.items[idx] = {...state.items[idx], ...it, updatedAt: new Date().toISOString() }; } }
  else{ state.items.unshift({ id: uid(), createdAt: nowISO(), updatedAt: new Date().toISOString(), ...it }); }
  persist(); clearForm(); render();
  // â€”â€” äº‘åŒæ­¥é˜Ÿåˆ—ï¼ˆåœ¨ä¸‹æ–¹ Supabase æ®µä¸­æ¥ç®¡ï¼‰ â€”â€”
}

function fillForm(it){ el("text").value=it.text||""; el("author").value=it.author||""; el("link").value=it.link||""; el("tags").value=(it.tags||[]).join(", "); el("tone").value=it.tone||""; el("lang").value=it.lang||""; el("rating").value=it.rating||""; state.editingId=it.id; el("saveBtn").textContent="ä¿å­˜ä¿®æ”¹"; window.scrollTo({top:0,behavior:"smooth"}); }

function onListClick(e){
  if(e.target.tagName!=="BUTTON") return;
  const act=e.target.dataset.act, id=e.target.dataset.id, item=state.items.find(x=>x.id===id); if(!item) return;
  if(act==="del"){ if(confirm("ç¡®å®šåˆ é™¤è¿™æ¡æ”¶è—å—ï¼Ÿ")){ state.items=state.items.filter(x=>x.id!==id); persist(); render(); } }
  else if(act==="edit"){ fillForm(item); }
  else if(act==="copy"){ navigator.clipboard.writeText(item.text).then(()=>{ e.target.textContent="å·²å¤åˆ¶"; setTimeout(()=> e.target.textContent="å¤åˆ¶å¥å­",1000); }); }
}

function exportJSON(){ const data=JSON.stringify(state.items,null,2); const blob=new Blob([data],{type:"application/json"}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="quotes-backup.json"; a.click(); URL.revokeObjectURL(url); }
function importJSON(file){
  const reader=new FileReader(); reader.onload=()=>{ try{ const arr=JSON.parse(reader.result); if(!Array.isArray(arr)) throw new Error("æ ¼å¼ä¸æ­£ç¡®"); const map=new Map(state.items.map(x=>[x.id,x])); for(const it of arr){ if(it && it.id){ map.set(it.id,it); } } state.items=[...map.values()]; persist(); render(); alert("å¯¼å…¥å®Œæˆ"); }catch(e){ alert("å¯¼å…¥å¤±è´¥ï¼š"+e.message); } }; reader.readAsText(file);
}
function randomOne(){ if(state.items.length===0){ alert("è¿˜æ²¡æœ‰å†…å®¹"); return; } const it=state.items[Math.floor(Math.random()*state.items.length)]; alert((it.text||"")+(it.author? "\n\nâ€” "+it.author:"")); }
function escapeHTML(s){ return (s||"").replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

document.getElementById("saveBtn").onclick=saveItem;
document.getElementById("resetBtn").onclick=clearForm;
document.getElementById("list").addEventListener("click",onListClick);
document.getElementById("search").addEventListener("input",render);
document.getElementById("exportBtn").onclick=exportJSON;
document.getElementById("importFile").addEventListener("change",e=> e.target.files[0] && importJSON(e.target.files[0]));
document.getElementById("navExport").onclick=exportJSON;
document.getElementById("navImportFile").addEventListener("change",e=> e.target.files[0] && importJSON(e.target.files[0]));
document.getElementById("randomBtn").onclick=randomOne;
document.getElementById("clearBtn").onclick=()=>{ if(confirm("è¿™ä¼šæ¸…ç©ºæœ¬åœ°æ‰€æœ‰æ”¶è—ï¼Œç¡®å®šå—ï¼Ÿ")){ state.items=[]; persist(); render(); } };
document.getElementById("navSync").onclick=()=> document.getElementById("syncBtn").click();

render();
</script>

<!-- ===================== Supabase äº‘åŒæ­¥ï¼ˆæ–¹æ¡ˆBï¼šé‚®ç®±+å¯†ç ç™»å½•ï¼‰ ===================== -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/** åˆå§‹åŒ– Supabase */
const SUPABASE_URL = "https://wwtluqwioyngzawmkvam.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind3dGx1cXdpb3luZ3phd21rdmFtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwMjc4NjEsImV4cCI6MjA3NjYwMzg2MX0.Jog8YR9_5XLK36LBPdzOP2ZXMkMRPhAeith0bPuqw8c";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const $signup = document.getElementById("signupBtn");
const $login  = document.getElementById("loginBtn");
const $linkLogin = document.getElementById("linkLoginBtn"); // å¤‡é€‰
const $logout = document.getElementById("logoutBtn");
const $sync   = document.getElementById("syncBtn");
const $email  = document.getElementById("emailInput");
const $pwd    = document.getElementById("passwordInput");
const $state  = document.getElementById("authState");

/** é‚®ç®± + å¯†ç æ³¨å†Œ */
$signup.onclick = async () => {
  const email = $email.value.trim(), password = $pwd.value.trim();
  if(!email || !password) return alert("è¯·å…ˆè¾“å…¥é‚®ç®±å’Œå¯†ç ");
  const { data, error } = await sb.auth.signUp({ email, password });
  if(error){
    alert("æ³¨å†Œå¤±è´¥ï¼š" + error.message);
  }else{
    // è‹¥ä½ åœ¨æ§åˆ¶å°å¼€å¯äº†â€œConfirm emailâ€ï¼Œè¿™é‡Œä¼šè¿”å›éœ€è¦éªŒè¯ï¼›å…³é—­åˆ™å¯ç›´æ¥ç™»å½•ã€‚
    alert("æ³¨å†ŒæˆåŠŸï¼Œå¦‚æ— æ³•ç›´æ¥ç™»å½•ï¼Œè¯·ç‚¹å‡»â€œç™»å½•â€ã€‚");
  }
};

/** é‚®ç®± + å¯†ç ç™»å½• */
$login.onclick = async () => {
  const email = $email.value.trim(), password = $pwd.value.trim();
  if(!email || !password) return alert("è¯·å…ˆè¾“å…¥é‚®ç®±å’Œå¯†ç ");
  const { data, error } = await sb.auth.signInWithPassword({ email, password });
  if(error) return alert("ç™»å½•å¤±è´¥ï¼š" + error.message);
  setAuthUI(data.user); syncNow();
};

/** é‚®ä»¶ï¼ˆMagic Linkï¼‰ç™»å½•ä½œä¸ºå¤‡é€‰ï¼ˆå¯åˆ ï¼‰ */
const REDIRECT_URL = "https://avaiel.github.io/-/";
$linkLogin.onclick = async () => {
  const email = $email.value.trim(); if(!email) return alert("è¯·è¾“å…¥é‚®ç®±");
  $linkLogin.disabled = true;
  const { error } = await sb.auth.signInWithOtp({ email, options:{ emailRedirectTo: REDIRECT_URL }});
  if(error){ alert("å‘é€å¤±è´¥ï¼š"+error.message); $linkLogin.disabled = false; }
  else{
    let t = 30; $linkLogin.textContent = `å·²å‘é€ï¼ˆ${t}sï¼‰`;
    const timer = setInterval(()=>{ t--; $linkLogin.textContent = `å·²å‘é€ï¼ˆ${t}sï¼‰`; if(t<=0){ clearInterval(timer); $linkLogin.textContent="é‚®ä»¶ç™»å½•"; $linkLogin.disabled=false; }}, 1000);
    alert("ç™»å½•é‚®ä»¶å·²å‘é€ã€‚å¦‚åœ¨é‚®ç®±Appå†…æ— æ³•å›è·³ï¼Œè¯·é€‰æ‹©â€œåœ¨æµè§ˆå™¨ä¸­æ‰“å¼€â€ã€‚");
  }
};

/** é€€å‡º/åŒæ­¥/çŠ¶æ€ */
$logout.onclick = async () => { await sb.auth.signOut(); setAuthUI(null); };
$sync.onclick = syncNow;

sb.auth.onAuthStateChange((_evt, sess)=> setAuthUI(sess?.user || null));
(async () => { const s = await sb.auth.getSession(); setAuthUI(s.data.session?.user||null); })();

function setAuthUI(user){
  if(user){
    $signup.style.display="none"; $login.style.display="none"; $linkLogin.style.display="none";
    $logout.style.display=""; $email.style.display="none"; $pwd.style.display="none";
    $state.textContent = `å·²ç™»å½•ï¼š${user.email}`; $state.className="status ok";
  }else{
    $signup.style.display=""; $login.style.display=""; $linkLogin.style.display="";
    $logout.style.display="none"; $email.style.display=""; $pwd.style.display="";
    $state.textContent = "æœªç™»å½•"; $state.className="status warn";
  }
}

/** â€”â€” ç¦»çº¿é˜Ÿåˆ—ï¼ˆä¿å­˜/åˆ é™¤å…¥é˜Ÿç­‰å¾…ä¸Šè¡Œï¼‰ â€”â€” */
const QUEUE_KEY = "quotes.queue.v1";
const getQueue = ()=> { try{return JSON.parse(localStorage.getItem(QUEUE_KEY))||[]}catch{return[]} };
const setQueue = q => localStorage.setItem(QUEUE_KEY, JSON.stringify(q));

const _saveItemRaw = saveItem;
saveItem = function(){
  const before = JSON.stringify(state.items||[]);
  _saveItemRaw();
  const after = JSON.parse(JSON.stringify(state.items||[]));
  const beforeSet = new Set(JSON.parse(before).map(x=>x.id));
  const diff = after.find(x=>!beforeSet.has(x.id)) || after[0];
  if(diff){
    diff.updatedAt = new Date().toISOString();
    const q = getQueue(); q.push({op:"upsert", row:diff}); setQueue(q);
  }
};
document.addEventListener("click", (e)=>{
  if(e.target?.dataset?.act === "del"){
    const id = e.target.dataset.id;
    const q = getQueue(); q.push({op:"delete", id, updatedAt:new Date().toISOString()}); setQueue(q);
  }
}, true);

/** â€”â€” åŒæ­¥ï¼ˆåˆå¹¶ï¼šè°æ–°ç”¨è°ï¼‰ â€”â€” */
async function syncNow(){
  const btn = document.getElementById("syncBtn");
  const old = btn.textContent;
  btn.disabled = true; btn.textContent = "æ­£åœ¨åŒæ­¥â€¦";

  try {
    const sess = await sb.auth.getSession();
    const user = sess?.data?.session?.user;
    if(!user){ alert("è¯·å…ˆç™»å½•ä»¥å¼€å¯åŒæ­¥"); return; }

    // 1) æ‹‰å–äº‘ç«¯ç°çŠ¶
    const { data:remote, error:err1 } = await sb
      .from("quotes")
      .select("*")
      .order("updated_at",{ascending:false});
    if(err1){ console.error(err1); alert("äº‘ç«¯æ‹‰å–å¤±è´¥ï¼š"+err1.message); return; }

    // 2) è®¡ç®—â€œéœ€è¦ä¸Šè¡Œâ€çš„æœ¬åœ°è®°å½•ï¼ˆäº‘ç«¯ä¸å­˜åœ¨ï¼Œæˆ–æœ¬åœ°è¾ƒæ–°ï¼‰
    const remoteMap = new Map();
    for(const r of remote){ remoteMap.set(r.id, r); }

    const local = load(); // æœ¬åœ°å…¨éƒ¨
    const toUpload = [];
    for(const it of local){
      const r = remoteMap.get(it.id);
      const localTS = new Date(it.updatedAt || it.createdAt || 0).toISOString();
      const remoteTS = r ? (r.updated_at || r.created_at || "") : "";
      if(!r || localTS > remoteTS){
        toUpload.push(normalizeRow(it));
      }
    }

    // 3) å…ˆå¤„ç†â€œç¦»çº¿é˜Ÿåˆ—â€çš„æ–°å¢/åˆ é™¤
    const q = getQueue();
    for(const item of q){
      if(item.op === "upsert"){
        const row = normalizeRow(item.row);
        const { error:e1 } = await sb.from("quotes").upsert(row, { onConflict:"id" });
        if(e1){ console.error(e1); alert("ä¸Šè¡Œå¤±è´¥ï¼š"+e1.message); return; }
      }else if(item.op === "delete"){
        const { error:e2 } = await sb.from("quotes").update({ deleted:true }).eq("id", item.id);
        if(e2){ console.error(e2); alert("åˆ é™¤å¤±è´¥ï¼š"+e2.message); return; }
      }
    }
    setQueue([]); // æ¸…é˜Ÿåˆ—

    // 4) å†æŠŠâ€œæœ¬åœ°è¾ƒæ–°/äº‘ç«¯ç¼ºå¤±â€çš„ä¹Ÿä¸€æ¬¡æ€§ upsert
    if(toUpload.length){
      // åˆ†æ‰¹æ¬¡é˜²è¶…æ—¶ï¼ˆ100æ¡ä¸€æ‰¹ï¼Œé€šå¸¸ä½ ä¸ä¼šè¿™ä¹ˆå¤šï¼Œä¿å®ˆå¤„ç†ï¼‰
      const chunkSize = 100;
      for(let i=0;i<toUpload.length;i+=chunkSize){
        const chunk = toUpload.slice(i, i+chunkSize);
        const { error:e3 } = await sb.from("quotes").upsert(chunk, { onConflict:"id" });
        if(e3){ console.error(e3); alert("æ‰¹é‡ä¸Šè¡Œå¤±è´¥ï¼š"+e3.message); return; }
      }
    }

    // 5) é‡æ–°æ‹‰å–ä¸€æ¬¡äº‘ç«¯ï¼Œåˆå¹¶æ¸²æŸ“ä¸ºå‡†
    const { data:finalRemote, error:err2 } = await sb
      .from("quotes")
      .select("*")
      .order("updated_at",{ascending:false});
    if(err2){ console.error(err2); alert("æ‹‰å–æœ€ç»ˆæ•°æ®å¤±è´¥ï¼š"+err2.message); return; }

    state.items = finalRemote.filter(r=>!r.deleted).map(fromRemote);
    persist(); render();

    btn.textContent = "åŒæ­¥å®Œæˆ âœ…";
  } catch (e) {
    console.error(e);
    alert("åŒæ­¥å¼‚å¸¸ï¼š"+ e.message);
  } finally {
    setTimeout(()=>{ btn.disabled = false; btn.textContent = old; }, 1200);
  }
}

/** ç»“æ„è½¬æ¢ï¼šå‰ç«¯ <-> æ•°æ®åº“ */
function normalizeRow(it){
  return {
    id: it.id,
    text: it.text,
    author: it.author || null,
    link: it.link || null,
    tags: (it.tags||[]).filter(Boolean),
    tone: it.tone || null,
    lang: it.lang || null,
    rating: (typeof it.rating==="number" && !Number.isNaN(it.rating)) ? it.rating : null,
    created_at: it.createdAt ? new Date(it.createdAt).toISOString() : new Date().toISOString(),
    updated_at: it.updatedAt ? new Date(it.updatedAt).toISOString() : new Date().toISOString(),
    deleted: false
  };
}
function fromRemote(r){
  return {
    id: r.id,
    text: r.text,
    author: r.author || "",
    link: r.link || "",
    tags: r.tags || [],
    tone: r.tone || "",
    lang: r.lang || "",
    rating: r.rating || "",
    createdAt: r.created_at ? r.created_at.slice(0,10) : "",
    updatedAt: r.updated_at || r.created_at,
    deleted: !!r.deleted
  };
}

/** ç™»å½•åæ¯ 5 åˆ†é’Ÿè‡ªåŠ¨åŒæ­¥ */
setInterval(async ()=>{ const s = await sb.auth.getSession(); if(s?.data?.session?.user){ syncNow(); } }, 5*60*1000);
</script>
</body>
</html>


