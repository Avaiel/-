<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>好词好句收藏夹</title>
<style>
  :root{
    --gap:14px; --radius:14px; --primary:#4b7bec; --bg:#f7f9fc; --card:#fff; --text:#222; --muted:#666; --line:#e8ebf2;
  }
  [data-theme="dark"]{
    --bg:#0f172a; --card:#111827; --text:#e5e7eb; --muted:#9ca3af; --line:#273246; --primary:#7aa2ff;
  }
  html,body{height:100%}
  body{
    font-family:"Inter","Noto Sans SC",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    background:var(--bg); color:var(--text);
    max-width:980px;margin:0 auto;padding:16px;
  }
  .nav{
    display:flex;align-items:center;gap:12px;
    background:var(--card); border-radius:16px; padding:10px 14px; margin:8px 0 16px;
    box-shadow:0 4px 14px rgba(0,0,0,.06); position:sticky; top:8px; z-index:5;
  }
  .brand{display:flex;align-items:center;gap:10px}
  .logo{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,var(--primary),#64b5f6)}
  .title{font-weight:700}
  .nav-right{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap}
  .btn{border:1px solid var(--line); background:transparent; color:var(--text);
    border-radius:10px; padding:8px 12px; font-size:14px; cursor:pointer; transition:.2s}
  .btn:hover{border-color:var(--primary); color:var(--primary)}
  .btn.primary{background:var(--primary); color:#fff; border-color:transparent}
  .btn.primary:hover{opacity:.95}
  .btn.icon{width:40px;height:36px;display:flex;align-items:center;justify-content:center}
  h1{display:none}
  .card{
    background:var(--card); border-radius:var(--radius);
    padding:20px; margin-bottom:var(--gap);
    box-shadow:0 4px 12px rgba(0,0,0,.08);
    transition:transform .2s, box-shadow .2s;
  }
  .card:hover{transform:translateY(-1px); box-shadow:0 8px 22px rgba(0,0,0,.08)}
  .row{display:flex;gap:var(--gap);flex-wrap:wrap}
  .row>*{flex:1 1 260px}
  input,textarea,select,button{
    width:100%; padding:10px 12px; border:1px solid var(--line); border-radius:10px;
    background:transparent; color:var(--text); font-size:14px; transition:border .2s, box-shadow .2s
  }
  input:focus,textarea:focus,select:focus{border-color:var(--primary); box-shadow:0 0 0 2px color-mix(in srgb,var(--primary) 30%, transparent); outline:none}
  textarea{min-height:90px; resize:vertical}
  a{color:var(--primary); text-decoration:none}
  a:hover{text-decoration:underline}
  .toolbar{display:flex;gap:var(--gap);flex-wrap:wrap;align-items:center}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .divider{height:1px;background:linear-gradient(90deg,var(--line),transparent);margin:10px 0}
  .status{font-size:12px;color:var(--muted)}
  .status.ok{color:#22c55e}
  .status.warn{color:#eab308}
  .quote{white-space:pre-wrap; line-height:1.7}
  .muted{color:var(--muted); font-size:12px}
  .tag{display:inline-block;padding:3px 8px;border:1px solid var(--line);border-radius:999px;margin-right:6px;margin-top:6px;background:color-mix(in srgb,var(--line) 40%, transparent); font-size:12px}
  .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);background:transparent;border-radius:999px;padding:6px 10px;margin:4px 6px 0 0;font-size:12px;cursor:pointer}
  .pill.active{border-color:var(--primary); background:color-mix(in srgb,var(--primary) 20%, transparent); color:var(--text)}
  .list-empty{padding:24px;text-align:center;color:var(--muted)}
  @media (max-width: 640px){
    body{padding:10px}
    .row>*{flex:1 1 100%}
    .nav-right{gap:6px}
  }
</style>
</head>
<body>

  <!-- 顶部导航 -->
  <div class="nav">
    <div class="brand">
      <div class="logo"></div>
      <div class="title">好词好句收藏夹</div>
    </div>
    <div class="nav-right">
      <button id="toggleTheme" class="btn icon" title="深浅色切换">🌙</button>
      <button id="navSync" class="btn">同步</button>
      <button id="navExport" class="btn">导出</button>
      <label class="btn" for="navImportFile">导入</label>
      <input id="navImportFile" type="file" accept=".json" style="display:none" />
    </div>
  </div>

  <!-- 顶部工具栏（搜索、备份、随机、清空 + 登录） -->
  <div class="card">
    <div class="toolbar">
      <input id="search" placeholder="搜索：句子 / 作者 / 标签…" />
      <div class="actions" style="flex:1 1 280px">
        <button id="exportBtn" class="btn">导出 JSON</button>
        <input id="importFile" type="file" accept=".json" />
        <button id="randomBtn" class="btn">来一句 🎲</button>
        <button id="clearBtn" class="btn" title="清空所有数据（谨慎）">清空</button>
      </div>

      <div class="divider" style="flex-basis:100%"></div>

      <!-- 登录 & 同步区（方案B：邮箱+密码） -->
      <div class="row" style="align-items:center">
        <input id="emailInput" placeholder="邮箱（用于登录/注册）" />
        <input id="passwordInput" type="password" placeholder="密码（首次可自定义）" />
        <button id="signupBtn" class="btn" style="flex:0 0 90px">注册</button>
        <button id="loginBtn" class="btn" style="flex:0 0 90px">登录</button>

        <!-- 保留邮件登录备选（可删除这两行） -->
        <button id="linkLoginBtn" class="btn" style="flex:0 0 120px">邮件登录</button>

        <button id="logoutBtn" class="btn" style="flex:0 0 90px;display:none">退出</button>
        <button id="syncBtn" class="btn" style="flex:0 0 90px">同步</button>
        <div id="authState" class="status" style="flex:1 1 200px;text-align:right">未登录</div>
      </div>
    </div>
    <div id="tagBar" class="row" style="margin-top:10px"></div>
  </div>

  <!-- 录入 -->
  <div class="card">
    <div class="row">
      <textarea id="text" placeholder="在此粘贴好词好句…"></textarea>
      <input id="author" placeholder="作者/出处（可选）" />
      <input id="link" placeholder="来源链接（可选）" />
      <input id="tags" placeholder="标签（用逗号分隔）" />
      <select id="tone">
        <option value="">情绪/语气（可选）</option>
        <option>温柔</option><option>激励</option><option>坚韧</option><option>幽默</option><option>清醒</option>
      </select>
      <select id="lang">
        <option value="">语言（可选）</option>
        <option>中文</option><option>English</option><option>日本語</option>
      </select>
      <input id="rating" type="number" min="1" max="5" step="1" placeholder="评分 1-5（可选）" />
    </div>
    <div class="actions" style="margin-top:12px">
      <button id="saveBtn" class="btn primary">保存</button>
      <button id="resetBtn" class="btn">重置表单</button>
    </div>
  </div>

  <!-- 列表 -->
  <div id="list"></div>

<script>
/* 主题切换（记忆） */
const themeToggleBtn = document.getElementById('toggleTheme');
const THEME_KEY = 'quotes.theme';
const applyTheme = (t)=>{ document.documentElement.setAttribute('data-theme', t); themeToggleBtn.textContent = t==='dark'?'☀️':'🌙'; localStorage.setItem(THEME_KEY,t); };
applyTheme(localStorage.getItem(THEME_KEY)|| (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark':'light'));
themeToggleBtn.onclick = ()=> applyTheme(document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark');

/* 本地应用逻辑（原有功能） */
const KEY = "quotes.v1";
const el = id => document.getElementById(id);

const state = { items: load(), editingId: null, activeTag: "" };

function load(){ try{ return JSON.parse(localStorage.getItem(KEY)) || []; } catch{ return []; } }
function persist(){ localStorage.setItem(KEY, JSON.stringify(state.items)); }
function uid(){ return Math.random().toString(36).slice(2,10) + Date.now().toString(36); }
function nowISO(){ return new Date().toISOString().slice(0,10); }

function render(){
  renderTagBar();
  const q = el("search").value.trim().toLowerCase();
  const activeTag = state.activeTag;
  const list = el("list"); list.innerHTML = "";
  let items = [...state.items].sort((a,b)=> (b.createdAt||"").localeCompare(a.createdAt||""));
  if(q){ items = items.filter(it =>
    (it.text||"").toLowerCase().includes(q) ||
    (it.author||"").toLowerCase().includes(q) ||
    (it.tags||[]).join(",").toLowerCase().includes(q)
  );}
  if(activeTag){ items = items.filter(it => (it.tags||[]).includes(activeTag)); }
  if(items.length===0){ const d = document.createElement("div"); d.className="list-empty"; d.textContent = "没有内容，先收藏第一句吧 ✨"; list.appendChild(d); return; }
  for(const it of items){
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <div class="quote">${escapeHTML(it.text)}</div>
      <div class="muted" style="margin-top:8px">
        ${it.author? `— ${escapeHTML(it.author)}`:""}
        ${it.link? ` · <a href="${it.link}" target="_blank" rel="noopener">链接</a>`:""}
        ${it.rating? ` · 评分 ${it.rating}/5`:""}
        ${it.lang? ` · ${it.lang}`:""}
        ${it.tone? ` · ${it.tone}`:""}
        · ${it.createdAt || ""}
      </div>
      <div style="margin-top:6px">${(it.tags||[]).map(t=>`<span class="tag">${escapeHTML(t)}</span>`).join("")}</div>
      <div class="actions" style="margin-top:10px">
        <button data-act="copy" data-id="${it.id}" class="btn">复制句子</button>
        <button data-act="edit" data-id="${it.id}" class="btn">编辑</button>
        <button data-act="del" data-id="${it.id}" class="btn">删除</button>
      </div>
    `;
    list.appendChild(card);
  }
}

function renderTagBar(){
  const all = new Set(); state.items.forEach(it => (it.tags||[]).forEach(t=> all.add(t)));
  const bar = el("tagBar"); bar.innerHTML = ""; if(all.size===0) return;
  const mk = (name, active)=> { const b = document.createElement("button"); b.className = "pill" + (active?" active":""); b.textContent = name; b.onclick = ()=>{ state.activeTag = (state.activeTag===name? "": name); render(); }; return b; };
  bar.appendChild(mk("全部", state.activeTag==="")); [...all].sort().forEach(t => bar.appendChild(mk(t, state.activeTag===t)));
}

function clearForm(){ el("text").value=""; el("author").value=""; el("link").value=""; el("tags").value=""; el("tone").value=""; el("lang").value=""; el("rating").value=""; state.editingId=null; el("saveBtn").textContent="保存"; }
function splitTags(s){ return s.split(",").map(x=>x.trim()).filter(Boolean); }

function saveItem(){
  const text = el("text").value.trim(); if(!text){ alert("请先填写句子内容"); return; }
  const it = {
    text, author: el("author").value.trim(), link: el("link").value.trim(),
    tags: splitTags(el("tags").value), tone: el("tone").value, lang: el("lang").value,
    rating: Number(el("rating").value||""),
  };
  if(state.editingId){ const idx = state.items.findIndex(x=>x.id===state.editingId); if(idx>-1){ state.items[idx] = {...state.items[idx], ...it, updatedAt: new Date().toISOString() }; } }
  else{ state.items.unshift({ id: uid(), createdAt: nowISO(), updatedAt: new Date().toISOString(), ...it }); }
  persist(); clearForm(); render();
  // —— 云同步队列（在下方 Supabase 段中接管） ——
}

function fillForm(it){ el("text").value=it.text||""; el("author").value=it.author||""; el("link").value=it.link||""; el("tags").value=(it.tags||[]).join(", "); el("tone").value=it.tone||""; el("lang").value=it.lang||""; el("rating").value=it.rating||""; state.editingId=it.id; el("saveBtn").textContent="保存修改"; window.scrollTo({top:0,behavior:"smooth"}); }

function onListClick(e){
  if(e.target.tagName!=="BUTTON") return;
  const act=e.target.dataset.act, id=e.target.dataset.id, item=state.items.find(x=>x.id===id); if(!item) return;
  if(act==="del"){ if(confirm("确定删除这条收藏吗？")){ state.items=state.items.filter(x=>x.id!==id); persist(); render(); } }
  else if(act==="edit"){ fillForm(item); }
  else if(act==="copy"){ navigator.clipboard.writeText(item.text).then(()=>{ e.target.textContent="已复制"; setTimeout(()=> e.target.textContent="复制句子",1000); }); }
}

function exportJSON(){ const data=JSON.stringify(state.items,null,2); const blob=new Blob([data],{type:"application/json"}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="quotes-backup.json"; a.click(); URL.revokeObjectURL(url); }
function importJSON(file){
  const reader=new FileReader(); reader.onload=()=>{ try{ const arr=JSON.parse(reader.result); if(!Array.isArray(arr)) throw new Error("格式不正确"); const map=new Map(state.items.map(x=>[x.id,x])); for(const it of arr){ if(it && it.id){ map.set(it.id,it); } } state.items=[...map.values()]; persist(); render(); alert("导入完成"); }catch(e){ alert("导入失败："+e.message); } }; reader.readAsText(file);
}
function randomOne(){ if(state.items.length===0){ alert("还没有内容"); return; } const it=state.items[Math.floor(Math.random()*state.items.length)]; alert((it.text||"")+(it.author? "\n\n— "+it.author:"")); }
function escapeHTML(s){ return (s||"").replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

document.getElementById("saveBtn").onclick=saveItem;
document.getElementById("resetBtn").onclick=clearForm;
document.getElementById("list").addEventListener("click",onListClick);
document.getElementById("search").addEventListener("input",render);
document.getElementById("exportBtn").onclick=exportJSON;
document.getElementById("importFile").addEventListener("change",e=> e.target.files[0] && importJSON(e.target.files[0]));
document.getElementById("navExport").onclick=exportJSON;
document.getElementById("navImportFile").addEventListener("change",e=> e.target.files[0] && importJSON(e.target.files[0]));
document.getElementById("randomBtn").onclick=randomOne;
document.getElementById("clearBtn").onclick=()=>{ if(confirm("这会清空本地所有收藏，确定吗？")){ state.items=[]; persist(); render(); } };
document.getElementById("navSync").onclick=()=> document.getElementById("syncBtn").click();

render();
</script>

<!-- ===================== Supabase 云同步（方案B：邮箱+密码登录） ===================== -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/** 初始化 Supabase */
const SUPABASE_URL = "https://wwtluqwioyngzawmkvam.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind3dGx1cXdpb3luZ3phd21rdmFtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwMjc4NjEsImV4cCI6MjA3NjYwMzg2MX0.Jog8YR9_5XLK36LBPdzOP2ZXMkMRPhAeith0bPuqw8c";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const $signup = document.getElementById("signupBtn");
const $login  = document.getElementById("loginBtn");
const $linkLogin = document.getElementById("linkLoginBtn"); // 备选
const $logout = document.getElementById("logoutBtn");
const $sync   = document.getElementById("syncBtn");
const $email  = document.getElementById("emailInput");
const $pwd    = document.getElementById("passwordInput");
const $state  = document.getElementById("authState");

/** 邮箱 + 密码注册 */
$signup.onclick = async () => {
  const email = $email.value.trim(), password = $pwd.value.trim();
  if(!email || !password) return alert("请先输入邮箱和密码");
  const { data, error } = await sb.auth.signUp({ email, password });
  if(error){
    alert("注册失败：" + error.message);
  }else{
    // 若你在控制台开启了“Confirm email”，这里会返回需要验证；关闭则可直接登录。
    alert("注册成功，如无法直接登录，请点击“登录”。");
  }
};

/** 邮箱 + 密码登录 */
$login.onclick = async () => {
  const email = $email.value.trim(), password = $pwd.value.trim();
  if(!email || !password) return alert("请先输入邮箱和密码");
  const { data, error } = await sb.auth.signInWithPassword({ email, password });
  if(error) return alert("登录失败：" + error.message);
  setAuthUI(data.user); syncNow();
};

/** 邮件（Magic Link）登录作为备选（可删） */
const REDIRECT_URL = "https://avaiel.github.io/-/";
$linkLogin.onclick = async () => {
  const email = $email.value.trim(); if(!email) return alert("请输入邮箱");
  $linkLogin.disabled = true;
  const { error } = await sb.auth.signInWithOtp({ email, options:{ emailRedirectTo: REDIRECT_URL }});
  if(error){ alert("发送失败："+error.message); $linkLogin.disabled = false; }
  else{
    let t = 30; $linkLogin.textContent = `已发送（${t}s）`;
    const timer = setInterval(()=>{ t--; $linkLogin.textContent = `已发送（${t}s）`; if(t<=0){ clearInterval(timer); $linkLogin.textContent="邮件登录"; $linkLogin.disabled=false; }}, 1000);
    alert("登录邮件已发送。如在邮箱App内无法回跳，请选择“在浏览器中打开”。");
  }
};

/** 退出/同步/状态 */
$logout.onclick = async () => { await sb.auth.signOut(); setAuthUI(null); };
$sync.onclick = syncNow;

sb.auth.onAuthStateChange((_evt, sess)=> setAuthUI(sess?.user || null));
(async () => { const s = await sb.auth.getSession(); setAuthUI(s.data.session?.user||null); })();

function setAuthUI(user){
  if(user){
    $signup.style.display="none"; $login.style.display="none"; $linkLogin.style.display="none";
    $logout.style.display=""; $email.style.display="none"; $pwd.style.display="none";
    $state.textContent = `已登录：${user.email}`; $state.className="status ok";
  }else{
    $signup.style.display=""; $login.style.display=""; $linkLogin.style.display="";
    $logout.style.display="none"; $email.style.display=""; $pwd.style.display="";
    $state.textContent = "未登录"; $state.className="status warn";
  }
}

/** —— 离线队列（保存/删除入队等待上行） —— */
const QUEUE_KEY = "quotes.queue.v1";
const getQueue = ()=> { try{return JSON.parse(localStorage.getItem(QUEUE_KEY))||[]}catch{return[]} };
const setQueue = q => localStorage.setItem(QUEUE_KEY, JSON.stringify(q));

const _saveItemRaw = saveItem;
saveItem = function(){
  const before = JSON.stringify(state.items||[]);
  _saveItemRaw();
  const after = JSON.parse(JSON.stringify(state.items||[]));
  const beforeSet = new Set(JSON.parse(before).map(x=>x.id));
  const diff = after.find(x=>!beforeSet.has(x.id)) || after[0];
  if(diff){
    diff.updatedAt = new Date().toISOString();
    const q = getQueue(); q.push({op:"upsert", row:diff}); setQueue(q);
  }
};
document.addEventListener("click", (e)=>{
  if(e.target?.dataset?.act === "del"){
    const id = e.target.dataset.id;
    const q = getQueue(); q.push({op:"delete", id, updatedAt:new Date().toISOString()}); setQueue(q);
  }
}, true);

/** —— 同步（合并：谁新用谁） —— */
async function syncNow(){
  const btn = document.getElementById("syncBtn");
  const old = btn.textContent;
  btn.disabled = true; btn.textContent = "正在同步…";

  try {
    const sess = await sb.auth.getSession();
    const user = sess?.data?.session?.user;
    if(!user){ alert("请先登录以开启同步"); return; }

    // 1) 拉取云端现状
    const { data:remote, error:err1 } = await sb
      .from("quotes")
      .select("*")
      .order("updated_at",{ascending:false});
    if(err1){ console.error(err1); alert("云端拉取失败："+err1.message); return; }

    // 2) 计算“需要上行”的本地记录（云端不存在，或本地较新）
    const remoteMap = new Map();
    for(const r of remote){ remoteMap.set(r.id, r); }

    const local = load(); // 本地全部
    const toUpload = [];
    for(const it of local){
      const r = remoteMap.get(it.id);
      const localTS = new Date(it.updatedAt || it.createdAt || 0).toISOString();
      const remoteTS = r ? (r.updated_at || r.created_at || "") : "";
      if(!r || localTS > remoteTS){
        toUpload.push(normalizeRow(it));
      }
    }

    // 3) 先处理“离线队列”的新增/删除
    const q = getQueue();
    for(const item of q){
      if(item.op === "upsert"){
        const row = normalizeRow(item.row);
        const { error:e1 } = await sb.from("quotes").upsert(row, { onConflict:"id" });
        if(e1){ console.error(e1); alert("上行失败："+e1.message); return; }
      }else if(item.op === "delete"){
        const { error:e2 } = await sb.from("quotes").update({ deleted:true }).eq("id", item.id);
        if(e2){ console.error(e2); alert("删除失败："+e2.message); return; }
      }
    }
    setQueue([]); // 清队列

    // 4) 再把“本地较新/云端缺失”的也一次性 upsert
    if(toUpload.length){
      // 分批次防超时（100条一批，通常你不会这么多，保守处理）
      const chunkSize = 100;
      for(let i=0;i<toUpload.length;i+=chunkSize){
        const chunk = toUpload.slice(i, i+chunkSize);
        const { error:e3 } = await sb.from("quotes").upsert(chunk, { onConflict:"id" });
        if(e3){ console.error(e3); alert("批量上行失败："+e3.message); return; }
      }
    }

    // 5) 重新拉取一次云端，合并渲染为准
    const { data:finalRemote, error:err2 } = await sb
      .from("quotes")
      .select("*")
      .order("updated_at",{ascending:false});
    if(err2){ console.error(err2); alert("拉取最终数据失败："+err2.message); return; }

    state.items = finalRemote.filter(r=>!r.deleted).map(fromRemote);
    persist(); render();

    btn.textContent = "同步完成 ✅";
  } catch (e) {
    console.error(e);
    alert("同步异常："+ e.message);
  } finally {
    setTimeout(()=>{ btn.disabled = false; btn.textContent = old; }, 1200);
  }
}

/** 结构转换：前端 <-> 数据库 */
function normalizeRow(it){
  return {
    id: it.id,
    text: it.text,
    author: it.author || null,
    link: it.link || null,
    tags: (it.tags||[]).filter(Boolean),
    tone: it.tone || null,
    lang: it.lang || null,
    rating: (typeof it.rating==="number" && !Number.isNaN(it.rating)) ? it.rating : null,
    created_at: it.createdAt ? new Date(it.createdAt).toISOString() : new Date().toISOString(),
    updated_at: it.updatedAt ? new Date(it.updatedAt).toISOString() : new Date().toISOString(),
    deleted: false
  };
}
function fromRemote(r){
  return {
    id: r.id,
    text: r.text,
    author: r.author || "",
    link: r.link || "",
    tags: r.tags || [],
    tone: r.tone || "",
    lang: r.lang || "",
    rating: r.rating || "",
    createdAt: r.created_at ? r.created_at.slice(0,10) : "",
    updatedAt: r.updated_at || r.created_at,
    deleted: !!r.deleted
  };
}

/** 登录后每 5 分钟自动同步 */
setInterval(async ()=>{ const s = await sb.auth.getSession(); if(s?.data?.session?.user){ syncNow(); } }, 5*60*1000);
</script>
</body>
</html>


